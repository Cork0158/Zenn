--- 
title: "ã€ŒDrogonã€å…¥é–€" 
emoji: "ğŸ“" 
type: "tech" 
topics: ["Drogon", "Web", "framework"] 
published: false 
--- 

ã¿ãªã•ã‚“ã€ã“ã‚“ã«ã¡ã¯ã€‚
corkï¼ˆã‚³ãƒ«ã‚¯ï¼‰ã§ã™ã€‚
ä»Šæ—¥ã¯Web ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯**Drogon**ã‚’ä½¿ã†æ©Ÿä¼šãŒã‚ã£ãŸã®ã§ã€ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã¨ã—ã¦è‡ªåˆ†ãŒã©ã®ã‚ˆã†ãªã“ã¨ã‚’è¡Œã£ãŸã‹ã‚’æ›¸ãæ®‹ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

# ã€ŒDrogonã€å…¥é–€

## Drogonã¨ã¯
[å…¬å¼HP](https://drogon.docsforge.com/)ã«ã‚ˆã‚‹ã¨
> Drogonã¯ã€C++14/17ãƒ™ãƒ¼ã‚¹ã®HTTPã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚

ã¨æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚
**Drogon**ã¯C++ã‚’ç”¨ã„ã¦ã•ã¾ã–ã¾ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒãƒ¼ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’æ›¸ã‘ã‚‹ã“ã¨ãŒç‰¹å¾´ã§ã‚ã‚Šã€Linuxãƒ»macOSãƒ»FreeBSDãƒ»OpenBSDãƒ»HaikuOSãƒ»Windowsãªã©å¹…åºƒã„OSã«å¯¾å¿œã—ã¦ã„ã‚‹ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚

ã¡ãªã¿ã«ã€**Drogon**ã®ç”±æ¥ã¯ã‚¢ãƒ¡ãƒªã‚«ã®ãƒ†ãƒ¬ãƒ“ã‚¢ãƒ‹ãƒ¡"Game of Thrones"ã«å‡ºã¦ãã‚‹ãƒ‰ãƒ©ã‚´ãƒ³ã®åå‰ã ãã†ã§ã™ã€‚
â€»ãƒ‰ãƒ©ã‚´ãƒ³ã®ç¶´ã‚Šã¯"Dragon"ã§ã™ãŒã€**Drogon**ã¯ã“ã†è¨€ã£ãŸç”±æ¥ã‹ã‚‰typoã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

è©³ã—ãã¯**Drogon**ã®[Getting Started](https://drogon.docsforge.com/master/)ã‚’è¦‹ã¦ãã ã•ã„ã€‚

## æ¦‚è¦
**Drogon**ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ä½¿ã£ã¦ã¿ã¾ã—ãŸã€‚**Drogon**ã¯2018å¹´4æœˆã«ç™ºè¡¨ã•ã‚ŒãŸã€æ¯”è¼ƒçš„æ–°ã—ã„ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®ãŸã‚ã€æ—¥æœ¬èªã®æ–‡çŒ®ãŒã‹ãªã‚Šå°‘ãªã„ã§ã™ã€‚ãã®ãŸã‚ã€ã“ã‚Œã‹ã‚‰**Drogon**ã‚’ä½¿ã£ã¦ã¿ã‚ˆã†ã¨ã„ã†äººå‘ã‘ã«ã“ã®è¨˜äº‹ã‚’åŸ·ç­†ã—ã¾ã—ãŸã€‚ç§ã¯ãã“ã¾ã§çŸ¥è­˜ã®ã‚ã‚‹æŠ€è¡“è€…ã§ã¯ãªã„ã®ã§ã€è§£é‡ˆãŒé–“é•ã£ã¦ã„ã‚‹éƒ¨åˆ†ãŒã‚ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚è¨‚æ­£ãªã©ã¯ã‚³ãƒ¡ãƒ³ãƒˆã§éšæ™‚å—ã‘ä»˜ã‘ã¦ã„ã¾ã™ã€‚
ã¾ãŸã€Macã§é–‹ç™ºã‚’ãŠã“ãªã£ãŸãŸã‚Macã®ä½¿ç”¨ã‚’å‰æã«è¨˜äº‹ã‚’æ›¸ã„ã¦ã„ã¾ã™ã€‚ï¼ˆLinuxãƒ»Windowsã®äººã”ã‚ã‚“ãªã•ã„ï¼‰


## é–‹ç™ºç’°å¢ƒ
- macOS Monterey 12.0.1
- intel Core i5
- dorogon 1.7.4

## ç’°å¢ƒæ§‹ç¯‰
### å¿…è¦ãƒ„ãƒ¼ãƒ«
MacOSã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ä»¥ä¸‹ã®ç’°å¢ƒãŒå¿…è¦ã§ã™ã€‚
- git
- gcc/g++
- cmake
- jsoncpp
- uuid
- OpenSSL
- zlib

MacOSã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã®ã§ã‚ã‚Œã°ã€ã™ã¹ã¦Homebrewã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå¯èƒ½ã§ã™ã€‚ã¾ã ã€Homebrewã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã“ã¨ãŒãªã„ã¨ã„ã†äººã¯[ã“ã¡ã‚‰](https://qiita.com/zaburo/items/29fe23c1ceb6056109fd)ã‚’å‚è€ƒã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

```shellsession
$ brew update
$ brew install git
$ brew install gcc
$ brew install cmake
$ brew install jsoncpp
$ brew install ossp-uuid
$ brew install openssl
$ brew install zlib
```

### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œã£ã¦ã€Githubã‹ã‚‰ã‚½ãƒ¼ã‚¹ã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã€ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚
ã“ã®è¨˜äº‹ã§ã¯ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®åå‰ã‚’ã€Œdrogon-testã€ã‚’ã—ã¾ã™ã€‚

```shellsession
$ mkdir drogon-test
$ cd drogon-test
$ git clone https://github.com/an-tao/drogon
$ cd drogon
$ git submodule update --init
$ mkdir build
$ cd build
$ cmake ..
$ make && sudo make install
```
ä¸Šè¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å©ãã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†ã§ã™ã€‚
æ­£å¸¸ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå‡ºæ¥ã¦ã„ãŸã‚‰`$ drogon-ctl -v`ã¨ã‚³ãƒãƒ³ãƒ‰ã‚’å©ãã¨ä»¥ä¸‹ã®å†™çœŸã®ã‚ˆã†ãªè¡¨ç¤ºãŒã•ã‚Œã‚‹ã¨æ€ã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/14aa1271b5b1-20211221.png)*dorogonã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ãƒ­ã‚´*

ã“ã‚Œã§ç’°å¢ƒæ§‹ç¯‰ã¯çµ‚äº†ã§ã™ã€‚
æ¬¡ã‹ã‚‰ã¯å®Ÿéš›ã«drogonã‚’ä½¿ã£ã¦ã„ãã¾ã™ã€‚

## ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¡ä¸Šã’ã‚‹

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹

ã¾ãšã€`drogon-test`ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¾ã§æˆ»ã‚Šã¾ã™ã€‚
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’æ‰“ã¤ã“ã¨ã§ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒä½œæˆã§ãã¾ã™ã€‚
```shellsession
$ drogon_ctl create project [YOUR_PROJECT_NAME]
$ cd [YOUR_PROJECT_NAME]
```
ã“ã®è¨˜äº‹ã§ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’ã€Œsampleã€ã¨ã—ã¾ã™ã€‚
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹ã¨ã ã„ãŸã„ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã§ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã‚‹ã¨æ€ã„ã¾ã™ã€‚

```markdown
.sample
â”œâ”€â”€ build               # ãƒ“ãƒ«ãƒ‰ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
â”œâ”€â”€ CMakeLists.txt      # cmakeç”¨ (Makefileç”Ÿæˆç”¨)
â”œâ”€â”€ config.json         # Drogonã‚¢ãƒ—ãƒªã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ controllers         # ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ç®¡ç†ç”¨
â”œâ”€â”€ filters             # ãƒ•ã‚£ãƒ«ã‚¿ç®¡ç†ç”¨
â”œâ”€â”€ main.cc             # ã‚¢ãƒ—ãƒª ãƒ¡ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ models              # ãƒ¢ãƒ‡ãƒ«ç®¡ç†ç”¨
â”‚   â””â”€â”€ model.json
â””â”€â”€ views               # ãƒ“ãƒ¥ãƒ¼ç®¡ç†ç”¨
```

`main.cc`ã¯ã“ã‚“ãªæ„Ÿã˜ã«ãªã£ã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã€‚

```cpp:main.cc
#include <drogon/drogon.h>
int main() {
    //Set HTTP listener address and port
    drogon::app().addListener("0.0.0.0",80);
    //Load config file
    //drogon::app().loadConfigFile("../config.json");
    //Run HTTP framework,the method will block in the internal event loop
    drogon::app().run();
    return 0;
}
```

ã“ã“ã§ã¯`drogon`ã¨ã„ã†åå‰ç©ºé–“ãŒä½¿ã‚ã‚Œã¦ã„ã¾ã™ãŒã€`using namespace drogon`ã§çœç•¥å¯èƒ½ã§ã™ã€‚åå‰ç©ºé–“ã«ã¤ã„ã¦ã‚ã‹ã‚‰ãªã„æ–¹ã¯èª¿ã¹ã¦ã¿ã¦ãã ã•ã„ã€‚

### ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¡ä¸Šã’ã‚‹
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å©ã„ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¡ä¸Šã’ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
```shellsession
$ cd build      # ãƒ“ãƒ«ãƒ‰ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ç§»å‹•
$ cmake ..      # Makefileç”Ÿæˆ
$ make          # ãƒ“ãƒ«ãƒ‰ã¨ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
$ ./sample      # å®Ÿè¡Œ
```

[http://localhost](http://localhost)ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/afee4b04f6cc-20211222.png)

htmlãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½•ã‚‚ä½œã£ã¦ãªã„ã®ã§`404 Not Found`ã¨è¡¨ç¤ºã•ã‚Œã€ãƒ•ãƒƒã‚¿ãƒ¼ã«ã¯**Drogon**ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

### ä¸­èº«ã‚’è¡¨ç¤ºã•ã›ã‚‹
ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã‚’ä¸€ã¤ä½œæˆã—ã€URLã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã¨ãã«ãªã«ã‹ãŒè¿”ã£ã¦ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å©ãã€ã€Œtestctrlã€ã¨ã„ã†åå‰ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã‚’ä½œæˆã—ã¾ã™ã€‚

```shellsession
$ cd ..
$ cd controllers
$ drogon_ctl create controller testctrl
```
ã“ã‚Œã§ã€`testctrl.h`ã¨`testctrl.cc`ãŒä½œæˆã•ã‚ŒãŸã¨æ€ã„ã¾ã™ã€‚

**Drogon**ã§ã¯ã€**ãƒ˜ãƒƒãƒ€ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã—ã€ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã«å‡¦ç†ã‚’æ›¸ã**ãŸã‚ä¸¡æ–¹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿®æ­£ã—ã¦ã„ãã¾ã™ã€‚
URLã«ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚ŒãŸã¨ãã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã•ã‚Œã‚‹ã‚ˆã†ã«ãƒ˜ãƒƒãƒ€ãƒ•ã‚¡ã‚¤ãƒ«ã«`ã€Œ/ã€`ã¨`ã€Œ/testã€`ã¨ã„ã†2ã¤ã®ãƒ‘ã‚¹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```diff cpp: testctrl.h
    #pragma once //ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ãƒ‰ã‚«ãƒ¼ãƒ‰
    #include <drogon/HttpSimpleController.h>
    using namespace drogon;
    class testctrl:public drogon::HttpSimpleController<testctrl>
    {
    public:
        virtual void asyncHandleHttpRequest(const HttpRequestPtr& req, std::function<void (const HttpResponsePtr &)> &&callback) override;
        PATH_LIST_BEGIN
        //list path definitions here;
        //PATH_ADD("/path","filter1","filter2",HttpMethod1,HttpMethod2...);

+       PATH_ADD("/", Get, Post);
+       PATH_ADD("/test", Get);

        PATH_LIST_END
    };
```

ç¶šã„ã¦ã€`testctrl.cc`ã‚‚ä¿®æ­£ã—ã¦ã„ãã¾ã™ã€‚

```diff cpp:testctrl.cc
    #include "testctrl.h"
    void testctrl::asyncHandleHttpRequest(const HttpRequestPtr& req, std::function<void (const HttpResponsePtr &)> &&callback)
    {
        //write your application logic here
+       auto resp = HttpResponse::newHttpResponse();  // æ–°ã—ã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆ
+       resp->setStatusCode(k200OK);  // HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ 200ã«è¨­å®š
+       resp->setContentTypeCode(CT_TEXT_HTML);  // Header: Content typeã‚’HTMLã«ã™ã‚‹
+       resp->setBody("<h1>Hello World!</h1>");  // Body:
+       callback(resp);
    }
```

ã§ã¯ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å©ã„ã¦å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```shellsession
$ cd ..
$ cd build
$ cmake ..
$ make
$ ./sample
```
[http://localhost](http://localhost)ã¨[http://localhost/test](http://localhost/test)ã®ã©ã¡ã‚‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã‚‚"Hello World!"ã¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã€‚

ã“ã®ã‚ˆã†ã«ãŸã£ãŸæ•°è¡Œã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹ã ã‘ã§ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã®è¨­å®šãŒå®Œäº†ã—ã¾ã™ã€‚

## Controllerå…¥é–€
### Controllerã¨ã¯
å…ˆã»ã©ã€Œtestctrlã€ã¨ã„ã†ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã‚’ä½œæˆã—ã¦ã€URLã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸæ™‚ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ãã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸãŒã€ãã‚‚ãã‚‚Controllerã¨ã¯ã©ã®ã‚ˆã†ãªå½¹å‰²ã‚’æŒã£ã¦ã„ã‚‹ã®ã§ã—ã‚‡ã†ã‹ã€‚

[å…¬å¼HP](https://drogon.docsforge.com/master/controller-introduction/)ã«ã‚ˆã‚‹ã¨ã€
>ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰é€ã‚‰ã‚ŒãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã—ã€ãƒ–ãƒ©ã‚¦ã‚¶ã¸ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç”Ÿæˆã—ã¾ã™

ã¨æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚è¦ã™ã‚‹ã«**é€ã‚‰ã‚Œã¦ããŸHTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚ˆã£ã¦ã©ã†ã„ã£ãŸå‡¦ç†ã‚’è¡Œã†ã‹ã‚’æ±ºå®šã™ã‚‹**é‡è¦ãªéƒ¨åˆ†ã§ã‚ã‚‹ã¨ã„ãˆã¾ã™ã€‚
å…ˆã»ã©ã¯**Drogon**ãŒã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã®ä¸­ã§ã€æœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãª`HttpSimpleController`ã‚’ä½¿ç”¨ã—ã¾ã—ãŸã€‚ä»Šå›ã¯ã‚ˆã‚Šå®Ÿç”¨çš„ãªã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã§ã‚ã‚‹`HttpController`ã‚’ä½¿ç”¨ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

ä»Šå›ã¯[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://drogon.docsforge.com/master/controller-introduction/controller-httpcontroller/)ã‚’å‚è€ƒã«èª¬æ˜ã—ã¦ã„ãã®ã§ã€ç´°ã‹ã„éƒ¨åˆ†ã§æ°—ã«ãªã‚‹ã¨ã“ã‚ãŒã‚ã‚Œã°ã“ã¡ã‚‰ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### HttpControllerã®ç”Ÿæˆ
`HttpSimpleController`ã‚’ç”Ÿæˆã—ãŸæ™‚ã¨åŒã˜ã‚ˆã†ã«`drogon_ctl`ã‚³ãƒãƒ³ãƒ‰ã‚’ç”¨ã„ã¦ç”Ÿæˆã—ã¾ã™ã€‚
é€šå¸¸ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ç”Ÿæˆã‚³ãƒãƒ³ãƒ‰ã¯`-h`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ãŸã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒãƒ³ãƒ‰ã§ç”Ÿæˆã—ã¾ã™ã€‚

```shellsession
$ drogon_ctl create controller -h <[namespace::]class_name>
```
åå‰ç©ºé–“ã¯çœç•¥å¯èƒ½ã§ã™ãŒã€åå‰ç©ºé–“ã®è¡çªã‚’é¿ã‘ã‚‹ãŸã‚ã«è¨­å®šã™ã‚‹ã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚

ã¾ãŸã€**Drogon**ã§ã¯åå‰ç©ºé–“ãŒãã®ã¾ã¾URLã«åæ˜ ã•ã‚Œã¾ã™ã€‚ä»Šå›ã¯[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://drogon.docsforge.com/master/controller-introduction/controller-httpcontroller/)ã«å¾“ã£ã¦ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å©ã„ã¦ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã‚’ä½œæˆã—ã¾ã—ãŸã€‚

```shellsession
$ cd controllers
$ drogon_ctl create controller -h demo::v1::User
```
ã“ã‚Œã§ã€ä»Šã‹ã‚‰ç·¨é›†ã™ã‚‹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã¯`http://localhost/demo/v1/user/{ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã—ãŸãƒ‘ã‚¹}`ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã¨ãã®å‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚

`controllers`ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¦‹ã¦ã¿ã‚‹ã¨`demo_v1_User.cc`ã¨`demo_v1_User.h`ã¨ã„ã†2ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ–°ãŸã«å‡ºæ¥ã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã€‚

```cpp:demo_v1_User.cc
#include "demo_v1_User.h"
using namespace demo::v1;
// add definition of your processing function here
```

```cpp:demo_v1_User.h
#pragma once
#include <drogon/HttpController.h>
using namespace drogon;
namespace demo {
namespace v1 {
class User : public drogon::HttpController<User> {
   public:
    METHOD_LIST_BEGIN
    // use METHOD_ADD to add your custom processing function here;
    // METHOD_ADD(User::get,"/{2}/{1}",Get);//path is
    // /demo/v1/User/{arg2}/{arg1}
    // METHOD_ADD(User::your_method_name,"/{1}/{2}/list",Get);//path is
    // /demo/v1/User/{arg1}/{arg2}/list
    // ADD_METHOD_TO(User::your_method_name,"/absolute/path/{1}/{2}/list",Get);//path
    // is /absolute/path/{arg1}/{arg2}/list

    METHOD_LIST_END
    // your declaration of processing function maybe like this:
    // void get(const HttpRequestPtr& req,std::function<void (const
    // HttpResponsePtr &)> &&callback,int p1,std::string p2); void
    // your_method_name(const HttpRequestPtr& req,std::function<void (const
    // HttpResponsePtr &)> &&callback,double p1,int p2) const;
};
}  // namespace v1
}  // namespace demo
```

### ãƒ•ã‚¡ã‚¤ãƒ«ã®ç·¨é›†
å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯`ã€Œ/info/{userId}ã€`ã§ãƒ¦ãƒ¼ã‚¶ ID ã¨åå‰ã‚’ JSON ã§è¿”ã™ã¨ã„ã†å‡¦ç†ã‚’è¡Œã†ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’æ›¸ã„ã¦ã„ã‚‹ã®ã§ã€å®Ÿè£…ã—ã¦ã¿ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚
ï¼ˆå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯`login`ã‚‚è¡Œã£ã¦ã„ã¾ã™ãŒã€èª¬æ˜ã‚’ç°¡ç•¥åŒ–ã™ã‚‹ãŸã‚ã«çœã„ã¦ã„ã¾ã™ï¼‰

ã¾ãšã€ãƒ˜ãƒƒãƒ€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¾ã™ã€‚

```diff cpp:demo_v1_User.h
    #pragma once
    #include <drogon/HttpController.h>
    using namespace drogon;
    namespace demo {
    namespace v1 {
    class User : public drogon::HttpController<User> {
    public:
        METHOD_LIST_BEGIN
        // use METHOD_ADD to add your custom processing function here;
        // METHOD_ADD(User::get,"/{2}/{1}",Get);//path is
        // /demo/v1/User/{arg2}/{arg1}
        // METHOD_ADD(User::your_method_name,"/{1}/{2}/list",Get);//path is
        // /demo/v1/User/{arg1}/{arg2}/list
        // ADD_METHOD_TO(User::your_method_name,"/absolute/path/{1}/{2}/list",Get);//path
        // is /absolute/path/{arg1}/{arg2}/list

+       METHOD_ADD(User::getInfo, "/info/{1}", Get);

        METHOD_LIST_END
        // your declaration of processing function maybe like this:
        // void get(const HttpRequestPtr& req,std::function<void (const
        // HttpResponsePtr &)> &&callback,int p1,std::string p2); void
        // your_method_name(const HttpRequestPtr& req,std::function<void (const
        // HttpResponsePtr &)> &&callback,double p1,int p2) const;

+       void getInfo(const HttpRequestPtr &req,
+                  std::function<void(const HttpResponsePtr &)> &&callback,
+                  std::string userId) const;
    };
    }  // namespace v1
    }  // namespace demo
```

ã“ã‚Œã§GETã§ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚ŒãŸå ´åˆã€`User::getInfo()`ã«å‡¦ç†ã‚’æŠ•ã’ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
æ¬¡ã«ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦ã„ãã¾ã™ã€‚

```diff cpp:demo_v1_User.cc
    #include "demo_v1_User.h"
    using namespace demo::v1;
    // add definition of your processing function here

+  void User::getInfo(
+       const HttpRequestPtr &req,
+       std::function<void(const HttpResponsePtr &)> &&callback,
+       std::string userId
+   ) const {
+       // LOG_DEBUGã§ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ä¸Šã«ã€ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹
+       LOG_DEBUG << "User " << userId << " get his information";
+
+       // ã“ã“ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‚ç…§ã—ãŸã‚Šã€ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹å‡¦ç†ãŒå…¥ã£ãŸã‚Šã™ã‚‹
+
+       Json::Value ret;
+
+       // JSONã«ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´
+       ret["result"] = "ok";
+       ret["user_name"] = "Jack";
+       ret["user_id"] = userId;
+       ret["gender"] = 1;
+
+       auto resp = HttpResponse::newHttpJsonResponse(ret);
+       callback(resp);
+   }
```

ã“ã‚Œã§ç·¨é›†ã¯å®Œäº†ã§ã™ã€‚å®Ÿéš›ã«å‹•ä½œç¢ºèªã‚’ã—ã¦è¦‹ã¾ã—ã‚‡ã†ã€‚

### å‹•ä½œç¢ºèª
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å©ã„ã¦ãƒ“ãƒ«ãƒ‰ã—ã¦ãã ã•ã„ã€‚
```shellsession
$ cd ..
$ cd build
$ cmake ..
$ make
$ ./sample
```
[http://localhost/demo/v1/user/info/123](http://localhost/demo/v1/user/info/123)ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/080fe9b34117-20211222.png)*/demo/v1/user/info/123*

ã“ã®ã‚ˆã†ã«ã€JSONå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦`{"gender":1,"result":"ok","user_id":"123","user_name":"Jack"}`ãŒè¿”ã£ã¦ãã¾ã™ã€‚
ã¾ãŸã€ã‚·ã‚§ãƒ«ã«ã¯ãƒ­ã‚°ã¨ã—ã¦
```
20211222 06:55:26.984065 UTC 2622569 DEBUG [getInfo] User 123 get his information - demo_v1_User.cc:11
```
ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã€‚ï¼ˆæ™‚é–“ã¯èª­è€…ã®ã¿ãªã•ã‚“ã«ä¾å­˜ã—ã¾ã™ã€‚ï¼‰

### URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ã•ã¾ã–ã¾ãªè¨˜æ³•

UserIDã‚’URLã§è¡¨ç¾ã™ã‚‹æ™‚ã«ã‚ˆãä½¿ã‚ã‚Œã‚‹`/info?userId={xxx}`ã®ã‚ˆã†ãªURLã‚‚`demo_v1_User.h`ã«ä»¥ä¸‹ã®å‡¦ç†ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§`/info/{xxx}`ã¨åŒæ§˜ã«å‡¦ç†ã§ãã¾ã™ã€‚

```cpp
METHOD_ADD(User::getInfo,"/info?userId={1}",Get);
```

ã“ã“ã§å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«æ›¸ã„ã¦ã‚ã‚‹URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è¨˜æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

1. `{}` : é€šå¸¸ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒãƒƒãƒ”ãƒ³ã‚°
2. `{1}, {2}`  : æ•°å­—ãŒå«ã¾ã‚ŒãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
3. `{anything}` : `{}` ã¨åŒã˜ã§å¯èª­æ€§å‘ä¸Šã®ãŸã‚ã«ä½•ã‹ã—ã‚‰æ–‡å­—åˆ—ã‚’å…¥ã‚Œã‚‹ã“ã¨ãŒã§ãã‚‹
4. `{1:anything}, {2:xxx}` : `{1}, {2}` ã¨åŒã˜ã§å¯èª­æ€§å‘ä¸Šã®ãŸã‚ã®ã‚‚ã®

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯3ç•ªç›®ã®è¨˜æ³•ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

ã“ã‚Œã‚’è¸ã¾ãˆã‚‹ã¨ä»¥ä¸‹ã®4ã¤ã¯ã™ã¹ã¦åŒã˜ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒè¡Œã‚ã‚Œã¾ã™ã€‚

- "/users/{}/books/{}"
- "/users/{}/books/{2}"
- "/users/{user_id}/books/{book_id}"
- "/users/{1:user_id}/books/{2}"

ã“ã‚Œã‚’ã¿ã¦ã‚ã‹ã‚‹ã‚ˆã†ã«ã€3ç•ªç›®ãŒã‹ãªã‚Šå¯èª­æ€§ãŒé«˜ã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚é–‹ç™ºè€…ç›®ç·šã§ã‚‚3ç•ªç›®ã‚’ä½¿ç”¨ã—ãŸã»ã†ãŒã„ã„ã§ã—ã‚‡ã†ã€‚

### multiple path mapping
ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¡Œãˆã°ã€è¤‡æ•°ã®URLãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’1ã¤ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã§å‡¦ç†ã§ãã¾ã™ã€‚
```cpp
ADD_METHOD_TO(UserController::handler1,"/users/.*",Post);
ADD_METHOD_TO(UserController::handler2,"/{name}/[0-9]+",Post); 
```
ã¾ãšã€ä¸Šã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã§ã¯`/users/`ãŒå…ˆé ­ã«ã‚ã‚‹ã™ã¹ã¦ã®URLã®å‡¦ç†ã‚’è¡Œã„ã€ä¸‹ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã§ã¯`/{æ–‡å­—åˆ—}/{æ•°å­—}`ã§è¡¨ç¾ã•ã‚Œã‚‹ã™ã¹ã¦ã®URLã®å‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚

ãŸã ã€ã“ã‚Œã ã‘ã§ãªãã‚‚ã£ã¨è¤‡é›‘ãªè¨­å®šã‚’è¡Œã„ãŸã„å ´é¢ã‚‚å‡ºã¦ãã‚‹ã¨æ€ã„ã¾ã™ã€‚ãã‚“ãªæ™‚ã¯æ­£è¦è¡¨ç¾ã‚’ç”¨ã„ã¦è¨˜è¿°ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### Regular expressionï¼ˆæ­£è¦è¡¨ç¾ï¼‰
å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªä¾‹ãŒè¼‰ã£ã¦ã„ã¾ã™ã€‚
```cpp
ADD_METHOD_VIA_REGEX(UserController::handler1,"/users/(.*)",Post);
ADD_METHOD_VIA_REGEX(UserController::handler2,"/.*([0-9]*)",Post);
ADD_METHOD_VIA_REGEX(UserController::handler3,"/(?!data).*",Post);
```
1ç•ªç›®ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã§ã¯ã€`/users/`ã‚’å…ˆé ­ã¨ã™ã‚‹ã™ã¹ã¦ã®URLã®å‡¦ç†ã‚’è¡Œã„ã€2ç•ªç›®ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã§ã¯æœ«å°¾ãŒæ•°å­—ã¨ãªã‚‹ã™ã¹ã¦ã®URLã®å‡¦ç†ã‚’è¡Œã„ã€3ç•ªç›®ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã§ã¯`/data`ã§å§‹ã¾ã‚‰ãªã„ã™ã¹ã¦ã®URLã®å‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚
ã“ã‚Œã‚’ã†ã¾ãä½¿ãˆã°ä»»æ„ã®URLã«å¯¾ã—ã¦ã‚‚ã‚Œãªãå‡¦ç†ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚ã ãŸã—ã€ç«¶åˆã—ãªã„ã‚ˆã†ã«æ³¨æ„ã—ã¾ã—ã‚‡ã†ã€‚

æ­£è¦è¡¨ç¾ã«ã¤ã„ã¦ã¯è§£èª¬ã—ã¦ã„ã‚‹æœ¬ã‚„ã‚µã‚¤ãƒˆãŒç„¡æ•°ã«ã‚ã‚‹ã®ã§è‡ªåˆ†ã«ã‚ã£ãŸæ–‡çŒ®ã‚’å‚è€ƒã«èª¿ã¹ã¦è¦‹ã¦ãã ã•ã„ã€‚